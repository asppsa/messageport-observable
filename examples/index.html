<!doctype html>
<html>
  <head>
    <script src="index.js"></script>
  </head>
  <body>
    <h1>Lets go!</h1>
    <iframe src="iframe.html"></iframe>
    <script>
      const iframe = document.querySelector('iframe');

      const wrapWindow = MessagePortObservable.wrapWindow;
      const wrapPort = MessagePortObservable.wrapPort;

      let iframePort = wrapWindow(iframe.contentWindow);
      let subscription = iframePort.subscribeAndPostReplies(event => {
        console.log('got from iframe:', event);
        subscription.unsubscribe();

        // Should yield each number in sequence to the iframe via a MessagePort
        return (function*() {
          yield 1;
          yield 2;
          yield 3;
        })();
      });

      let worker = new Worker('worker.js');
      let workerPort = wrapPort(worker);
      workerPort.postMessageWithReply('ping', replyPort => {
        let sub = replyPort
          .filter(event => event.data === 'pong')
          .observable.subscribe({
            next(x) {
              console.log('pong from worker', x);
              sub.unsubscribe();
            }
          });

        replyPort.start();
      });

      workerPort.postMessageWithReply('pong', replyPort => {
        let sub = replyPort
          .filter(event => event.data === 'ping')
          .observable.subscribe({
            next(x) {
              console.log('ping from worker', x);
              sub.unsubscribe();
            }
          });

        replyPort.start();
      });

      let sharedWorker = new SharedWorker('increment.js');
      sharedWorker.onerror = console.log;

      let swPort = wrapPort(sharedWorker.port);

      for (let i = 0; i < 10; i ++) {
        swPort.postMessageWithReply('inc', replyPort => {
          let sub = replyPort.observable.subscribe({
            next(x) {
              console.log('increment ' + i + ' via main window:', x.data);
              sub.unsubscribe();
            }
          });
        });

        swPort.postMessageWithReply('dec', replyPort => {
          let sub = replyPort.observable.subscribe({
            next(x) {
              console.log('decrement ' + i + ' via main window:', x.data);
              sub.unsubscribe();
            }
          });
        });
      }
    </script>
  </body>
</html>
